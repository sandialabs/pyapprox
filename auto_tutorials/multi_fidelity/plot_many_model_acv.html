<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Approximate Control Variate Monte Carlo &mdash; PyApprox 1.0.3 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sg_gallery-rendered-html.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script>window.MathJax = {"tex": {"macros": {"V": ["{\\boldsymbol{#1}}", 1], "mean": ["{\\mathbb{E}\\left[#1\\right]}", 1], "var": ["{\\mathbb{V}\\left[#1\\right]}", 1], "rv": "{z}", "rvset": "{\\mathcal{Z}}", "reals": "\\mathbb{R}", "pdf": "\\rho", "rvdom": "\\Gamma", "coloneqq": "\\colon=", "norm": ["{\\lVert #1 \\rVert}", 1], "argmax": ["\\operatorname{argmax}"], "argmin": ["\\operatorname{argmin}"], "covar": ["\\mathbb{C}\\text{ov}\\left[#1,#2\\right]", 2], "corr": ["\\mathbb{C}\\text{or}\\left[#1,#2\\right]", 2], "ai": "\\alpha", "bi": "\\beta", "dx": ["\\;\\text{d}#1", 1], "mat": ["{\\boldsymbol{\\mathrm{#1}}}", 1]}}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Delta-Based Covariance Formulas For Approximate Control Variates" href="acv_covariances.html" />
    <link rel="prev" title="Two model Approximate Control Variate Monte Carlo" href="plot_approximate_control_variates.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            PyApprox
              <img src="../../_static/pyapprox-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../auto_examples/index.html">Software Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Theoretical Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#model-analysis">Model Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#inference">Inference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#experimental-design">Experimental Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#surrogates">Surrogates</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#multi-fidelity-methods">Multi-Fidelity Methods</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="plot_monte_carlo.html">Monte Carlo Quadrature</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multioutput_monte_carlo.html">Monte Carlo Quadrature: Beyond Mean Estimation</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_control_variate_monte_carlo.html">Two Model Control Variate Monte Carlo</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_approximate_control_variates.html">Two model Approximate Control Variate Monte Carlo</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Approximate Control Variate Monte Carlo</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#video">Video</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="acv_covariances.html">Delta-Based Covariance Formulas For Approximate Control Variates</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_allocation_matrices.html">Approximate Control Variate Allocation Matrices</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multi_level_monte_carlo.html">Multi-level Monte Carlo</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multi_fidelity_monte_carlo.html">Multi-fidelity Monte Carlo</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_pacv.html">Parametrically Defined Approximate Control Variates</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multioutput_acv.html">Multioutput Approximate Control Variates</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_pilot_studies.html">Pilot Studies</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_ensemble_selection.html">Model Ensemble Selection</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multilevel_blue.html">Multilevel Best Linear Unbiased estimators (MLBLUE)</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multiindex_collocation.html">Multi-level and Multi-index Collocation</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_multifidelity_gp.html">Multifidelity Gaussian processes</a></li>
<li class="toctree-l3"><a class="reference internal" href="plot_gaussian_mfnets.html">MFNets: Multi-fidelity networks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Benchmarks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../benchmarks.html">Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User Reference Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../user_reference_guide.html">User Reference Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyApprox</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Theoretical Tutorials</a></li>
      <li class="breadcrumb-item active">Approximate Control Variate Monte Carlo</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/auto_tutorials/multi_fidelity/plot_many_model_acv.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-tutorials-multi-fidelity-plot-many-model-acv-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code</p>
</div>
<section class="sphx-glr-example-title" id="approximate-control-variate-monte-carlo">
<span id="sphx-glr-auto-tutorials-multi-fidelity-plot-many-model-acv-py"></span><h1>Approximate Control Variate Monte Carlo<a class="headerlink" href="#approximate-control-variate-monte-carlo" title="Permalink to this heading"></a></h1>
<p>This tutorial builds upon <a class="reference internal" href="plot_approximate_control_variates.html#sphx-glr-auto-tutorials-multi-fidelity-plot-approximate-control-variates-py"><span class="std std-ref">Two model Approximate Control Variate Monte Carlo</span></a>, <a class="reference internal" href="plot_multi_level_monte_carlo.html#sphx-glr-auto-tutorials-multi-fidelity-plot-multi-level-monte-carlo-py"><span class="std std-ref">Multi-level Monte Carlo</span></a>, and <a class="reference internal" href="plot_multi_fidelity_monte_carlo.html#sphx-glr-auto-tutorials-multi-fidelity-plot-multi-fidelity-monte-carlo-py"><span class="std std-ref">Multi-fidelity Monte Carlo</span></a>. MLMC and MFMC are two approaches which can utilize an ensemble of models of vary cost and accuracy to efficiently estimate the expectation of the highest fidelity model. In this tutorial we introduce a general framework for ACVMC when using two or more models to estimate vector-valued statistics.</p>
<p>The approximate control variate estimator of a vector-valued statistic <span class="math notranslate nohighlight">\(\mat{Q}_0\in\reals^{S}\)</span> that uses  <span class="math notranslate nohighlight">\(M\)</span> lower fidelity models is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mat{Q}_{\text{ACV}}(\rvset_0,\rvset_1^*,\rvset_1,\ldots,\rvset^*_M, \rvset_M) &amp;= \mat{Q}_{0}(\rvset_0)+\begin{bmatrix}\eta_{1,1} &amp; \cdots &amp;\eta_{1, SM}\\
\eta_{2,1} &amp; \cdots &amp;\eta_{2, SM}\\
\vdots\\
\eta_{S,1} &amp; \cdots &amp;\eta_{S, SM}
\end{bmatrix}\begin{bmatrix} \mat{Q}_{1}(\rvset_1^*)-\mat{Q}_{1}(\rvset_1) \\ \mat{Q}_{2}(\rvset_2^*)-\mat{Q}_{2}(\rvset_2) \\ \vdots \\ \mat{Q}_{M}(\rvset_M^*)-\mat{Q}_{M}(\rvset_M)\end{bmatrix}\in\reals^{S}\end{split}\]</div>
<p>or in more compact notation</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mat{Q}_{\text{ACV}}(\rvset_\text{ACV})&amp;=\mat{Q}_{0}(\rvset_0)+\mat{\eta}\mat{\Delta}(\rvset_{\Delta}), \quad \mat{\Delta}(\rvset_\Delta) = \begin{bmatrix}\mat{\Delta}_1(\rvset_1^*, \rvset_1)\\ \vdots\\ \mat{\Delta}_M(\rvset_M^*,\rvset_M)\end{bmatrix}\in\reals^{SM}, \quad \mat{\eta}\in\reals^{S\times SM},\end{split}\]</div>
<p>where the entries of <span class="math notranslate nohighlight">\(\mat{\eta}\)</span> are called control variate weights, <span class="math notranslate nohighlight">\(\rvset_\Delta=\{\rvset_1^*, \rvset_1, \ldots, \rvset_M^*, \rvset_M\}\)</span>, and <span class="math notranslate nohighlight">\(\rvset_\text{ACV}=\{\rvset_0, \rvset_\Delta\}\)</span>.</p>
<p>Here <span class="math notranslate nohighlight">\(\mat{\eta}=[\eta_1,\ldots,\eta_M]^T\)</span>, <span class="math notranslate nohighlight">\(\mat{\Delta}=[\Delta_1,\ldots,\Delta_M]^T\)</span>, and <span class="math notranslate nohighlight">\(\rvset_{\alpha}^*\)</span>, <span class="math notranslate nohighlight">\(\rvset_{\alpha}\)</span> are sample sets that may or may not be disjoint. Specifying the exact nature of these sets, including their cardinality, can be used to design different ACV estimators which will discuss later.</p>
<p>This estimator is constructed by evaluating each model at two sets of samples <span class="math notranslate nohighlight">\(\rvset_{\alpha}^*=\{\rv^{(n)}\}_{n=1}^{N_{\alpha^*}}\)</span> and <span class="math notranslate nohighlight">\(\rvset_{\alpha}=\{\rv^{(n)}\}_{n=1}^{N_\alpha}\)</span> where some samples may be shared between sets such that in some cases <span class="math notranslate nohighlight">\(\rvset_{\alpha}^*\cup\rvset_{\beta}\neq \emptyset\)</span>.</p>
<p>For any <span class="math notranslate nohighlight">\(\mat{\eta}(\rvset_\text{ACV})\)</span>, the covariance of the ACV estimator is</p>
<div class="math notranslate nohighlight">
\[\var{\mat{Q}^{\text{ACV}}} = \var{\mat{Q}_{0}}+\mat{\eta}\covar{\mat{\Delta}}{\mat{\Delta}}\mat{\eta}^\top+\mat{\eta}\covar{\mat{\Delta}}{\mat{Q}_0}+\covar{\mat{\Delta}}{\mat{Q}_0}\mat{\eta}^\top, \qquad\in\reals^{S\times S}\]</div>
<p>The control variate weights that minimize the determinant of the ACV estimator covariance are</p>
<div class="math notranslate nohighlight">
\[\mat{\eta} = -\covar{\mat{\Delta}}{\mat{\Delta}}^{-1}\covar{\mat{\Delta}}{\mat{Q}_0}\]</div>
<p>The ACV estimator covariance using the optimal control variate weights is</p>
<div class="math notranslate nohighlight">
\[\covar{\mat{Q}_{\text{ACV}}}{\mat{Q}_{\text{ACV}}}(\rvset_\text{ACV})=\covar{\mat{Q}_0}{ \mat{Q}_0}-\covar{\mat{Q}_0}{\mat{\Delta}}\covar{\mat{\Delta}}{\mat{\Delta}}^{-1}\covar{\mat{Q}_0}{\mat{\Delta}}^\top\]</div>
<p>Computing the ACV estimator covariance requires computing <span class="math notranslate nohighlight">\(\covar{\mat{Q}_0}{\mat{\Delta}}\text{ and} \covar{\mat{\Delta}}{\mat{\Delta}}\)</span>.</p>
<p>First</p>
<div class="math notranslate nohighlight">
\[\begin{split}\covar{\mat{\Delta}}{\mat{\Delta}} =
\begin{bmatrix}\covar{\mat{\Delta}_1}{\mat{\Delta}_1} &amp; \covar{\mat{\Delta}_1}{\mat{\Delta}_2} &amp; \cdots &amp; \covar{\mat{\Delta}_1}{\mat{\Delta}_M}\\
\covar{\mat{\Delta}_2}{\mat{\Delta}_1} &amp; \covar{\mat{\Delta}_1}{\mat{\Delta}_2} &amp;  &amp; \vdots\\
\vdots &amp; &amp; \ddots &amp; \vdots \\
\covar{\mat{\Delta}_M}{\mat{\Delta}_1} &amp; \cdots &amp; \cdots &amp; \covar{\mat{\Delta}_M}{\mat{\Delta}_M}
\end{bmatrix}\end{split}\]</div>
<p>and second</p>
<div class="math notranslate nohighlight">
\[\covar{\mat{Q}_0}{\mat{\Delta}} = [\covar{\mat{Q}_0}{\mat{\Delta}_1}, \ldots, \covar{\mat{Q}_0}{\mat{\Delta}_M}]\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\covar{\mat{Q}_0}{\mat{\Delta}_\alpha} = \covar{\mat{Q}_0(\rvset_0)}{\mat{\Delta}_\alpha(\rvset_\alpha^*)}-\covar{\mat{Q}_0(\rvset_0)}{\mat{\Delta}_\alpha(\rvset_\alpha)}]\]</div>
<p>When estimating the statistics in <a class="reference internal" href="plot_multioutput_monte_carlo.html#sphx-glr-auto-tutorials-multi-fidelity-plot-multioutput-monte-carlo-py"><span class="std std-ref">Monte Carlo Quadrature: Beyond Mean Estimation</span></a>  the above coavariances involving <span class="math notranslate nohighlight">\(\Delta\)</span> can be computed using the formula in <a class="reference internal" href="acv_covariances.html#sphx-glr-auto-tutorials-multi-fidelity-acv-covariances-py"><span class="std std-ref">Delta-Based Covariance Formulas For Approximate Control Variates</span></a>.</p>
<p>The variance of an ACV estimator is dependent on how samples are allocated to the sets <span class="math notranslate nohighlight">\(\rvset_\alpha,\rvset_\alpha^*\)</span>, which we call the sample allocation <span class="math notranslate nohighlight">\(\mathcal{A}\)</span>. Specifically, <span class="math notranslate nohighlight">\(\mathcal{A}\)</span> specifies: the number of samples in the sets <span class="math notranslate nohighlight">\(\rvset_\alpha,\rvset_\alpha^*, \forall \alpha\)</span>, denoted by <span class="math notranslate nohighlight">\(N_\alpha\)</span> and <span class="math notranslate nohighlight">\(N_{\alpha^*}\)</span>, respectively; the number of samples in the intersections of pairs of sets, that is <span class="math notranslate nohighlight">\(N_{\alpha\cap\beta} =|\rvset_\alpha \cap \rvset_\beta|\)</span>, <span class="math notranslate nohighlight">\(N_{\alpha^*\cap\beta} =|\rvset_\alpha^* \cap \rvset_\beta|\)</span>, <span class="math notranslate nohighlight">\(N_{\alpha^*\cap\beta^*} =|\rvset_\alpha^* \cap \rvset_\beta^*|\)</span>; and the number of samples in the union of pairs of sets <span class="math notranslate nohighlight">\(N_{\alpha\cup\beta} = |\rvset_\alpha\cup \rvset_\beta|\)</span> and similarly <span class="math notranslate nohighlight">\(N_{\alpha^*\cup\beta}\)</span>, <span class="math notranslate nohighlight">\(N_{\alpha^*\cup\beta^*}\)</span>. Thus, finding the best ACV estimator can be theoretically be found by solving the constrained non-linear optimization problem</p>
<div class="math notranslate nohighlight">
\[\min_{\mathcal{A}\in\mathbb{A}}\mathrm{Det}\left[\covar{\mat{Q}_{\text{ACV}}}{\mat{Q}_{\text{ACV}}}\right](\mathcal{A}) \qquad \mathrm{s.t.} \qquad C(\mat{c},\tilde{\mathcal{A}})\le C_\mathrm{max},\]</div>
<p>Here, <span class="math notranslate nohighlight">\(\tilde{\mathcal{A}}\)</span> is the set of all possible sample allocations, and given the computational costs of evaluating each model once <span class="math notranslate nohighlight">\(c^\top=[c_0, c_1, \ldots, c_M]\)</span>, the constraint ensures that the computational cost of computing the ACV estimator</p>
<div class="math notranslate nohighlight">
\[C(\mat{c},\mathcal{A})=\sum_{\alpha=0}^M N_{\alpha^*\cup\alpha}c_\alpha\]</div>
<p>is smaller than a user-specified computational budget <span class="math notranslate nohighlight">\(C_\mathrm{max}\)</span>.</p>
<p>Unfortunately, to date, no method has been devised to solve the above optimization problem for all possible allocations <span class="math notranslate nohighlight">\(\tilde{\mathcal{A}}\)</span>. Consequently, all existing ACV methods restrict the optimization space to <span class="math notranslate nohighlight">\(\mathcal{A}\subset\tilde{\mathcal{A}}\)</span>. These restricted search spaces are formulated in terms of a set of <span class="math notranslate nohighlight">\(M+1\)</span> independent sample partitions <span class="math notranslate nohighlight">\(\mathcal{P}_m\)</span> that contain <span class="math notranslate nohighlight">\(p_m\)</span> samples drawn indepedently from the PDF of the random variable <span class="math notranslate nohighlight">\(\rv\)</span>. Each subset <span class="math notranslate nohighlight">\(\rvset_\alpha\)</span> is then assumed to consist of a combinations of these indepedent partitions. ACV methods encode the relationship between the sets <span class="math notranslate nohighlight">\(\rvset_\alpha\)</span> and <span class="math notranslate nohighlight">\(\mathcal{P}_m\)</span> via allocation matrices <span class="math notranslate nohighlight">\(\mat{A}\)</span>. For example, the allocation matrix used by MFMC, which is an ACV method, when applied to three models is given by</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mat{A} = \begin{bmatrix}
 0 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1\\
 0 &amp; 0 &amp; 0 &amp; 1 &amp; 1 &amp; 1 &amp; 1 &amp; 1\\
 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 1 &amp; 1\\
 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
 \end{bmatrix}\end{split}\]</div>
<p>An entry of one indicates in the ith row of the jth column indicates that the ith independent partition <span class="math notranslate nohighlight">\(\mathcal{P}_i\)</span> is used in the corresponding set <span class="math notranslate nohighlight">\(\rvset_j\)</span> if j is odd or <span class="math notranslate nohighlight">\(\rvset_j^*\)</span> if j is even. The first column will always only contain zeros because the set <span class="math notranslate nohighlight">\(\rvset_0^*\)</span> is never used by ACV estimators.</p>
<p>Once an allocation matrix is specified, the optimal sample allocation can be obtained by optimizing the number of samples in each partition <span class="math notranslate nohighlight">\(\mat{p}=[p_0,\ldots,p_M]^\top\)</span>, that is</p>
<div class="math notranslate nohighlight">
\[\min_{\mat{p}}\mathrm{Det}\left[\covar{\mat{Q}_{\text{ACV}}}{\mat{Q}_{\text{ACV}}}\right](\mat{p}; \mat{A}) \qquad \mathrm{s.t.} \qquad C(\mat{c},\mat{p};\mat{A})\le C_\mathrm{max},\]</div>
<p>The following tutorials introduce different ACV methods and their allocation matrices that have been introduced in the literature.</p>
<p>The following compares the estimator variances of three different ACV estimators. No one estimator type is best for all problems. Consequently for any given problem all possible estimators should be constructed. This requires estimates of the model covariance using a pilot study see <a class="reference internal" href="plot_pilot_studies.html#sphx-glr-auto-tutorials-multi-fidelity-plot-pilot-studies-py"><span class="std std-ref">Pilot Studies</span></a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">pyapprox.util.visualization</span> <span class="kn">import</span> <span class="n">mathrm_labels</span>
<span class="kn">from</span> <span class="nn">pyapprox.benchmarks</span> <span class="kn">import</span> <span class="n">setup_benchmark</span>
<span class="kn">from</span> <span class="nn">pyapprox.multifidelity.factory</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_estimator</span><span class="p">,</span> <span class="n">compare_estimator_variances</span><span class="p">,</span> <span class="n">multioutput_stats</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyapprox.multifidelity.visualize</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">plot_estimator_variance_reductions</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">benchmark</span> <span class="o">=</span> <span class="n">setup_benchmark</span><span class="p">(</span><span class="s2">&quot;polynomial_ensemble&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">benchmark</span><span class="o">.</span><span class="n">fun</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_covariance_matrix</span><span class="p">()</span>
<span class="n">nmodels</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">target_costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1e2</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">10</span><span class="o">**-</span><span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmodels</span><span class="p">)])</span>
<span class="n">model_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$f_0$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$f_1$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$f_2$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$f_3$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$f_4$&#39;</span><span class="p">]</span>

<span class="n">stat</span> <span class="o">=</span> <span class="n">multioutput_stats</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">](</span><span class="n">benchmark</span><span class="o">.</span><span class="n">nqoi</span><span class="p">)</span>
<span class="n">stat</span><span class="o">.</span><span class="n">set_pilot_quantities</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">estimators</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">get_estimator</span><span class="p">(</span><span class="s2">&quot;mlmc&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">costs</span><span class="p">),</span>
    <span class="n">get_estimator</span><span class="p">(</span><span class="s2">&quot;mfmc&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">costs</span><span class="p">),</span>
    <span class="n">get_estimator</span><span class="p">(</span><span class="s2">&quot;gmf&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">costs</span><span class="p">,</span>
                  <span class="n">recursion_index</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmodels</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))]</span>
<span class="n">est_labels</span> <span class="o">=</span> <span class="n">mathrm_labels</span><span class="p">([</span><span class="s2">&quot;MLMC&quot;</span><span class="p">,</span> <span class="s2">&quot;MFMC&quot;</span><span class="p">,</span> <span class="s2">&quot;ACVMF&quot;</span><span class="p">])</span>
<span class="n">optimized_estimators</span> <span class="o">=</span> <span class="n">compare_estimator_variances</span><span class="p">(</span>
    <span class="n">target_costs</span><span class="p">,</span> <span class="n">estimators</span><span class="p">)</span>

<span class="n">axs</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))[</span><span class="mi">1</span><span class="p">]]</span>

<span class="c1"># get estimators for target cost = 100</span>
<span class="n">ests_100</span> <span class="o">=</span> <span class="p">[</span><span class="n">ests</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">ests</span> <span class="ow">in</span> <span class="n">optimized_estimators</span><span class="p">]</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_estimator_variance_reductions</span><span class="p">(</span>
    <span class="n">ests_100</span><span class="p">,</span> <span class="n">est_labels</span><span class="p">,</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
<img src="../../_images/sphx_glr_plot_many_model_acv_001.png" srcset="../../_images/sphx_glr_plot_many_model_acv_001.png" alt="plot many model acv" class = "sphx-glr-single-img"/><section id="video">
<h2>Video<a class="headerlink" href="#video" title="Permalink to this heading"></a></h2>
<p>Click on the image below to view a video tutorial on approximate control variate Monte Carlo quadrature</p>
<a class="reference external image-reference" href="https://youtu.be/G8YGH3U2A8s?si=xQuQzxxqkZJo7PST"><img alt="../../_images/acv-thumbnail.png" src="../../_images/acv-thumbnail.png" /></a>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  0.338 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-tutorials-multi-fidelity-plot-many-model-acv-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/cd2641bbd5705f095b0e9c2d9aedd762/plot_many_model_acv.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_many_model_acv.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/b00cdb03738b7e966d9333b52d785a47/plot_many_model_acv.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_many_model_acv.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="plot_approximate_control_variates.html" class="btn btn-neutral float-left" title="Two model Approximate Control Variate Monte Carlo" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="acv_covariances.html" class="btn btn-neutral float-right" title="Delta-Based Covariance Formulas For Approximate Control Variates" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019 National Technology &amp; Engineering Solutions of Sandia, LLC (NTESS). Under the terms of Contract DE-NA0003525 with NTESS, the U.S. Government retains certain rights in this software..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>